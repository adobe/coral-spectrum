<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Coral.Select</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../build/css/coral.css">
    <script src="../build/js/coral.js"></script>
    <!-- We use jQuery for remote AJAX requests and parsing HTML response -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <style>
      .col {
        width: 30%;
        margin-right: 3%;
        display: inline-block;
        vertical-align: top;
      }

      #log {
        border: 1px solid #bababa;
        height: 100px;
        overflow-y: scroll;
        padding: 10px 10px 10px 25px;
        margin: 0;
      }
    </style>
  </head>

  <body class="coral--light u-coral-padding">
    <section>
      <div class="col">
        <h1 class="coral-Heading coral-Heading--1">Single mode</h1>
        <h2 class="coral-Heading coral-Heading--2"><label id="label-1">Remote markup + appendChild</label></h2>
        <form method="GET">
          <coral-select name="single_markup" placeholder="Choose your favorite browser" id="single_markup" labelledby="label-1">
          </coral-select>
          <button type="submit" is="coral-button">Submit</button>
        </form>
        <br/>
        <h2 class="coral-Heading coral-Heading--2"><label id="label-2">Remote markup + items</label></h2>
        <form method="GET">
          <coral-select name="single_markup_items" placeholder="Click to load remote markup" id="single_markup_items" labelledby="label-2">
          </coral-select>
          <button type="submit" is="coral-button">Submit</button>
        </form>
        <br/>
        <h2 class="coral-Heading coral-Heading--2"><label id="label-3">Remote JSON + item creation</label></h2>
        <form method="GET">
          <coral-select name="single_json_init" placeholder="Click to load remote JSON" id="single_json_init" labelledby="label-3">
          </coral-select>
          <button type="submit" is="coral-button">Submit</button>
        </form>
        <br/>
        <h2 class="coral-Heading coral-Heading--2"><label id="label-4">Infinity</label></h2>
        <form method="GET">
          <coral-select name="single_infinity" placeholder="Infinite items" id="single_infinity" labelledby="label-4">
          </coral-select>
          <button type="submit" is="coral-button">Submit</button>
        </form>
      </div>
      <div class="col">
        <h2 class="coral-Heading coral-Heading--2"><label id="label-5">Multiple mode</label></h2>
        <form method="GET">
          <coral-select name="multiple" placeholder="Favorite countries in America" id="multiple" labelledby="label-5" multiple>
          </coral-select>
          <button type="submit" is="coral-button">Submit</button>
        </form>
      </div>
      <div class="col">
        <h1 class="coral-Heading coral-Heading--1">Log</h1>
        <ul id="log"></ul>
      </div>
    </section>
    <script type="text/javascript">
      const log = document.getElementById('log');

      document.addEventListener('change', function(event) {
        const li = document.createElement('li');
        li.innerHTML = 'change: ' + event.target + ' count: ' + event.target.selectedItems.length + ' value: ' + event.target.value;
        log.insertBefore(li, log.firstChild);
      });

      document.addEventListener('coral-collection:add', function(event) {
        const li = document.createElement('li');
        li.innerHTML = 'add: ' + event.target + '  ' + event.detail.item.content.textContent;
        log.insertBefore(li, log.firstChild);
      });

      document.addEventListener('coral-collection:remove', function(event) {
        const li = document.createElement('li');
        li.innerHTML = 'remove: ' + event.target + '  ' + event.detail.item.content.textContent;
        log.insertBefore(li, log.firstChild);
      });

      document.addEventListener('coral-select:showitems', function(event) {
        const li = document.createElement('li');
        li.innerHTML = 'showitems: start=' + event.detail.start;
        log.insertBefore(li, log.firstChild);
      });

      document.addEventListener('coral-select:hideitems', function(event) {
        const li = document.createElement('li');
        li.innerHTML = 'hideitems';
        log.insertBefore(li, log.firstChild);
      });

      var countriesInAmerica = [
        {value: 'ar', content: 'Argentina'},
        {value: 'bh', content: 'Bahamas'},
        {value: 'br', content: 'Barbados'},
        {value: 'bz', content: 'Belize'},
        {value: 'bo', content: 'Bolivia'},
        {value: 'br', content: 'Brazil'},
        {value: 'ca', content: 'Canada'},
        {value: 'ch', content: 'Chile'},
        {value: 'co', content: 'Colombia'},
        {value: 'cr', content: 'Costa Rica'},
        {value: 'cu', content: 'Cuba'},
        {value: 'do', content: 'Dominican Republic'},
        {value: 'ec', content: 'Ecuador'},
        {value: 'el', content: 'El Salvador'},
        {value: 'gu', content: 'Guatemala'},
        {value: 'gy', content: 'Guyana'},
        {value: 'ha', content: 'Haiti'},
        {value: 'ho', content: 'Honduras'},
        {value: 'ja', content: 'Jamaica'},
        {value: 'mx', content: 'Mexico'},
        {value: 'ni', content: 'Nicaragua'},
        {value: 'pa', content: 'Panama'},
        {value: 'pg', content: 'Paraguay'},
        {value: 'pe', content: 'Peru'},
        {value: 'us', content: 'United States'},
        {value: 'uy', content: 'Uruguay'},
        {value: 've', content: 'Venezuela'}
      ];

      /* ==================================
       Remote example 1:

       This example loads remote data as markup and inserts it into the select using appendChild. Data will only be
       loaded once, since we know that the dataset is quite small.
       =====================================
       */
      var requestSingleMarkup;
      var singleMarkup = document.querySelector('#single_markup');
      singleMarkup.addEventListener('coral-select:showitems', function(event) {

        // we kill any existing request
        if (requestSingleMarkup) {
          requestSingleMarkup.abort();
        }

        // we use this a way to determine that we don't need to load any more data. typically a page size will be used
        // and once server returns less data than the requested, we know there's no more data to load.
        if (event.detail.start > 0) {
          return;
        }

        // causes it to show the loading inside the selectlist
        event.preventDefault();

        // Ask the server for suggestions
        requestSingleMarkup = $.get(
          // handling the loading our selves gives us the oportunity to use URITemplates
          'data/markup.html',
          function(html) {
            setTimeout(function() {
              $(singleMarkup).append($(html));
            }, 1000);
          }
        );
      });

      /* ==================================
       Remote example 2:

       Just like the previous example, we load markup but use the Collection API to insert the items. Data will only
       be loaded once, since we know that the dataset is quite small.
       =====================================
       */
      var requestSingleMarkupItems;
      var singleMarkupItems = document.querySelector('#single_markup_items');
      singleMarkupItems.addEventListener('coral-select:showitems', function(event) {

        // we kill any existing request
        if (requestSingleMarkupItems) {
          requestSingleMarkupItems.abort();
        }

        // we use this a way to determine that we don't need to load any more data. typically a page size will be used
        // and once server returns less data than the requested, we know there's no more data to load.
        if (event.detail.start > 0) {
          return;
        }

        // causes it to show the loading inside the selectlist
        event.preventDefault();

        // Ask the server for suggestions
        requestSingleMarkupItems = $.get(
          // handling the loading our selves gives us the oportunity to use URITemplates
          'data/markup.html',
          function(html) {
            setTimeout(function() {

              $(html).each(function(index, value) {
                // we make sure it is a proper item
                if (value.tagName === 'CORAL-SELECT-ITEM') {
                  singleMarkupItems.items.add(value);
                }
              });
            }, 1000);
          }
        );
      });

      /* ==================================
       Remote example 3:

       Remote data is loaded as JSON which is used to create the new coral-select-items. They are inserted using
       the Collection API.
       =====================================
       */
      var requestSingleJsonInit;
      var singleMarkupJsonInit = document.querySelector('#single_json_init');

      // modifying this value will not allow you to load more or less data, since the JSON files need to be modified
      // accordingly
      var PAGE_SIZE = 10;

      var singleJsonInitTimeout;
      singleMarkupJsonInit.addEventListener('coral-select:showitems', function loadData(event) {

        // we kill any existing request
        if (requestSingleJsonInit) {
          requestSingleJsonInit.abort();
        }

        // Stop previous request
        clearTimeout(singleJsonInitTimeout);

        // causes it to show the loading inside the selectlist
        event.preventDefault();

        // Ask the server for suggestions
        requestSingleJsonInit = $.get(
          // we use the event.detail.start as a way of doing pagination
          'data/countries.' + event.detail.start + '.json',
          function(data) {
            singleJsonInitTimeout = setTimeout(function() {

              var totalItems = data.length;
              var item;
              for (var i = 0; i < totalItems; i++) {

                // option 1:
                item = document.createElement('coral-select-item');
                item.value = data[i].value;
                item.content.textContent = data[i].content;

                // please note that the following code is also valid: singleMarkupJsonInit.appendChild(item);
                singleMarkupJsonInit.items.add(item);

                // option 2:
                // please note the following code would also be valid, given the format of the loaded JSON
                // singleMarkupJsonInit.items.add(data[i]);
              }

              // since the amount requested data was not satisfied, we can remove the listener
              if (totalItems < PAGE_SIZE) {
                singleMarkupJsonInit.removeEventListener('coral-select:showitems', loadData);
              }
            }, 1000);
          }
        );
      });

      /* ==================================
       Remote example 4:

       This example will randomly generate data infinitely.
       =====================================
       */
      var singleInfinityTimeout;
      var singleInfinity = document.querySelector('#single_infinity');
      singleInfinity.addEventListener('coral-select:showitems', function(event) {

        // Stop previous request
        clearTimeout(singleInfinityTimeout);

        // causes it to show the loading inside the selectlist
        event.preventDefault();

        // Make a request and show suggestions from that
        singleInfinityTimeout = setTimeout(function() {

          var id;
          for (var i = 0; i < 6; i++) {
            id = Coral.commons.getUID();
            singleInfinity.items.add({value: id, content: {textContent: id}});
          }
        }, 1000);
      });

      /* ==================================
       Remote example 5:

       Loads fake date into a multiple select. It properly handles paging, based on the parameters provided by the
       event detail.
       =====================================
       */
      var MULTIPLE_PAGE_SIZE = 5;

      var multipleTimeout;
      var multiple = document.querySelector('#multiple');
      multiple.addEventListener('coral-select:showitems', function(event) {

        // based on the amount of the items that the select currently has
        var start = event.detail.start;
        var end = MULTIPLE_PAGE_SIZE + start;

        // if we have reached the end of the array there is nothing else to do
        if (start >= countriesInAmerica.length) {
          return;
        }

        // Stop previous request
        clearTimeout(multipleTimeout);

        // causes it to show the loading inside the selectlist
        event.preventDefault();

        // Make a request and show suggestions from that
        multipleTimeout = setTimeout(function() {
          countriesInAmerica.slice(start, end).forEach(function(item, index) {
            multiple.items.add({
              value: item.value,
              content: {
                textContent: item.content
              }
            });
          });
        }, 1000);
      });
    </script>
  </body>

</html>
